<div class="page container">
    <div class="header">
        <h1>Dossiers soumis</h1>
        <span *ngIf="total" class="total">{{ total }} dossiers</span>
    </div>

    <div class="toolbar">
        <div class="search">
            <i class="fas fa-search"></i>
            <input [(ngModel)]="q" placeholder="Rechercher titre / email…" />
        </div>

        <select [(ngModel)]="status" (change)="setPage(0)">
            <option value="SOUMIS">Soumis</option>
            <option value="ACCEPTE">Acceptés</option>
            <option value="REJETE">Rejetés</option>
            <option value="EN_COURS">En cours</option>
        </select>

        <button class="btn ghost" (click)="load()" [disabled]="loading">
            <i class="fas fa-sync"></i> Rafraîchir
        </button>
    </div>

    <div class="card">
        <div *ngIf="message" class="alert">{{ message }}</div>

        <div class="table">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Titre</th>
                        <th>Propriétaire</th>
                        <th>Soumis le</th>
                        <th>Statut</th>
                        <th class="col-actions">Actions</th> <!-- ✅ ICI, une seule colonne Actions -->

                    </tr>
                </thead>

                <tbody>
                    <tr *ngFor="let d of filteredRows">
                        <td>{{ d.id }}</td>
                        <td>{{ d.titre }}</td>
                        <td>{{ d.ownerEmail }}</td>
                        <td>{{ d.submittedAt | date:'dd/MM/yyyy, HH:mm' }}</td>
                        <td>
                            <span class="badge" [ngClass]="d.status">
                                {{ labels[d.status] || d.status }}
                            </span>
                        </td>

                        <!-- ✅ une seule cellule pour les boutons -->
                        <td class="col-actions">
                            <div class="row-actions"> <!-- wrapper flex -->
                                <button type="button" class="btn btn-sm" (click)="open(d.id)"
                                    title="Ouvrir dans un onglet">
                                    <i class="fas fa-eye"></i> Voir
                                </button>

                                <button type="button" class="btn btn-sm btn-pdf" (click)="download(d.id, d.titre)"
                                    title="Télécharger PDF">
                                    <i class="fas fa-file-pdf"></i> Télécharger PDF
                                </button>

                                <button type="button" class="btn btn-sm primary" *ngIf="d.status === 'SOUMIS'"
                                    (click)="startValidation(d)" title="Ouvrir le dossier au Step 1 pour le valider">
                                    <i class="fas fa-clipboard-check"></i> Valider
                                </button>

                                <!-- Actions -->
                                <button type="button" class="btn btn-sm success"
                                    *ngIf="d.status === 'SOUMIS' || d.status === 'EN_COURS'"
                                    [disabled]="isActionDisabled(d)" [class.is-disabled]="isActionDisabled(d)"
                                    [attr.aria-disabled]="isActionDisabled(d)"
                                    (click)="!isActionDisabled(d) && accept(d)">
                                    <i class="fas fa-check"></i> Accepter
                                </button>

                                <button type="button" class="btn btn-sm danger"
                                    *ngIf="d.status === 'SOUMIS' || d.status === 'EN_COURS'"
                                    [disabled]="isActionDisabled(d)" [class.is-disabled]="isActionDisabled(d)"
                                    [attr.aria-disabled]="isActionDisabled(d)"
                                    (click)="!isActionDisabled(d) && reject(d)">
                                    <i class="fas fa-times"></i> Rejeter
                                </button>

                            </div>
                        </td>





                    </tr>
                </tbody>

            </table>
        </div>

        <div class="pager" *ngIf="total > size">
            <button class="btn tiny" (click)="setPage(page - 1)" [disabled]="page === 0">
                Précédent
            </button>
            <span>Page {{ page + 1 }} / {{ Math.ceil(total / size) }}</span>
            <button class="btn tiny" (click)="setPage(page + 1)" [disabled]="(page + 1) >= Math.ceil(total / size)">
                Suivant
            </button>
        </div>
    </div>
</div>