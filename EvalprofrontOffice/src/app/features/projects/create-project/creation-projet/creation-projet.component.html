<div *ngIf="isLoading" class="loading">
  Chargement du formulaire...
</div>

<form *ngIf="!isLoading" [formGroup]="formGroup" (ngSubmit)="submit()">
  <div formArrayName="responses">
    <div *ngFor="let q of questions; let i = index" [formGroupName]="i" class="form-group mb-4">

      <!-- Titre de section -->
      <h3 *ngIf="q.type === 'SECTION_TITLE'" class="text-primary mb-3">
        {{ q.text }}
      </h3>

      <!-- Champ texte ou numérique -->
      <ng-container *ngIf="q.type === 'TEXTE' || q.type === 'NUMERIQUE'">
        <label class="form-label">{{ q.text }}</label>
        <input type="{{ q.type === 'NUMERIQUE' ? 'number' : 'text' }}" class="form-control" formControlName="value"
          [placeholder]="q.placeholder || ''" (blur)="onFieldBlur(i)" />
        <div class="text-danger" *ngIf="showError(i)">
          Ce champ est requis
        </div>
      </ng-container>

      <!-- Choix multiple -->
      <ng-container *ngIf="q.type === 'CHOIXMULTIPLE' && q.options?.length">
        <label class="form-label d-block">{{ q.text }}</label>
        <div class="form-check" *ngFor="let opt of q.options">
          <input type="checkbox" class="form-check-input" [value]="opt.id" [checked]="isOptionChecked(i, opt.id)"
            (change)="onCheckboxToggle(i, opt.id, $event)" />
          <label class="form-check-label">{{ opt.value }}</label>
        </div>
        <div class="text-danger" *ngIf="showError(i)">
          Veuillez sélectionner au moins une option
        </div>
      </ng-container>

<!-- Liste déroulante dynamique -->
<ng-container *ngIf="(q.type === 'RADIO' || q.type === 'SELECT') && q.options?.length">
  <label class="form-label">{{ q.text }}</label>

  <select class="form-control" formControlName="value"
          (change)="onSelectChange(q.id, $event)" (blur)="onFieldBlur(i)">
    <option value="">-- Sélectionnez une option --</option>
    <option
      *ngFor="let opt of (q.id === 11 ? filteredOptions11 : q.id === 12 ? filteredOptions12 : q.options)"
      [value]="opt.id">
      {{ opt.value }}
    </option>
  </select>

  <div class="text-danger" *ngIf="showError(i)">
    Veuillez sélectionner une option
  </div>
</ng-container>


<!-- Zone de texte pour "Autres" (optionId = 27) -->
<div *ngIf="shouldShowAutresTextField()" class="form-group mt-3">
  <label class="form-label">Merci de préciser si "Autres"</label>
  <input type="text" class="form-control" [formControl]="autresCtrl" placeholder="Détaillez ici..." />
  <div class="text-danger" *ngIf="autresCtrl.invalid && isSubmitted">
    Ce champ est requis.
  </div>
</div>



    </div>
  </div>

  <div class="d-flex justify-content-between mt-4">
    <button type="button" class="btn btn-outline-secondary" (click)="goBack()">Retour</button>
    <button type="submit" class="btn btn-primary">Valider</button>
  </div>
</form>