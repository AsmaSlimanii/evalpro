<div class="form-container">
    <form [formGroup]="formGroup" (ngSubmit)="submit()" *ngIf="!isLoading">

        <!-- ✅ En-tête -->
        <div class="form-header text-center">
            <h2 class="form-title">{{ formMetadata?.title || 'Informations sur l’entreprise' }}</h2>
        </div>

        <div class="form-subtitle-box">
            Merci de renseigner les informations relatives à votre entreprise.
        </div>

        <!-- ✅ Questions dynamiques -->
        <div formArrayName="responses">
            <ng-container *ngFor="let q of allQuestions; let i = index; trackBy: trackByQuestionId">
                <div [formGroupName]="i">
                    <ng-container *ngIf="shouldDisplayQuestion(q) && !q.isHidden">

                        <!-- TITRE DE SECTION -->
                        <div *ngIf="q.type === 'SECTION_TITLE'" class="section-title-block">
                            <h3 class="text-primary mb-3">{{ q.text }}</h3>
                        </div>

                        <!-- Autres types -->
                        <div *ngIf="q.type !== 'SECTION_TITLE'" class="form-section">

                            <!-- TEXTE / NUMERIQUE -->
                            <div *ngIf="q.type === 'TEXTE' || q.type === 'NUMERIQUE'" class="input-container">
                                <label class="label">
                                    {{ q.text }}
                                    <span *ngIf="q.required" class="required-asterisk">*</span>
                                </label>
                                <div class="input-wrapper">
                                    <input [type]="q.type === 'NUMERIQUE' ? 'number' : 'text'" class="input"
                                        formControlName="value" [placeholder]="q.placeholder || 'Votre réponse'"
                                        [readonly]="isAdmin" [disabled]="isAdmin"
                                        [class.invalid]="!isAdmin && showError(i)" (blur)="onFieldBlur(i)" />
                                </div>
                                <div class="error-text" *ngIf="showError(i)">Ce champ est requis</div>
                            </div>

                            <!-- CHOIX MULTIPLE -->
                            <div *ngIf="q.type === 'CHOIXMULTIPLE'" class="option-group">
                                <label class="label">
                                    {{ q.text }}
                                    <span *ngIf="q.required" class="required-asterisk">*</span>
                                </label>
                                <div *ngFor="let opt of q.options" class="checkbox-container">
                                    <label class="checkbox-label">
                                        <input type="checkbox" class="checkbox-input" [value]="opt.id"
                                            [checked]="isOptionChecked(i, opt.id)"
                                            (change)="onCheckboxToggle(i, opt.id, $event)" [disabled]="isAdmin"
                                            [class.invalid]="!isAdmin && showError(i)" />
                                        <span class="checkbox-custom"></span>
                                        <span class="checkbox-text">{{ opt.value }}</span>
                                    </label>
                                </div>
                            </div>

                            <!-- RADIO -->
                            <div *ngIf="q.type === 'RADIO'" class="option-group">
                                <label class="label">
                                    {{ q.text }}
                                    <span *ngIf="q.required" class="required-asterisk">*</span>
                                </label>
                                <div *ngFor="let opt of q.options" class="radio-container">
                                    <label class="radio-label">
                                        <input type="radio" [value]="opt.id" [checked]="isRadioSelected(i, opt.id)"
                                            (change)="onRadioChange(i, opt.id)" name="radio-{{i}}"
                                            [disabled]="isAdmin" />
                                        <span class="radio-text">{{ opt.value }}</span>
                                    </label>
                                </div>
                            </div>
                            <!-- SELECTION -->
                            <div *ngIf="q.type === 'SELECT' && q.options?.length" class="input-container">
                                <div class="input-wrapper">
                                    <select class="input" [formControlName]="'value'" [class.invalid]="showError(i)"
                                        [disabled]="isAdmin">
                                        <option value="" disabled selected>Veuillez sélectionner une option</option>
                                        <option *ngFor="let opt of q.options" [value]="opt.id">{{ opt.value }}</option>
                                    </select>

                                    <svg *ngIf="showError(i)" class="input-error-icon"
                                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="error-text" *ngIf="showError(i)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    Veuillez sélectionner une option.
                                </div>
                            </div>


                            <!-- UPLOAD -->
                            <div *ngIf="q.type === 'UPLOAD'" class="input-container">
                                <label class="label">
                                    {{ q.text }}
                                    <span *ngIf="q.required" class="required-asterisk">*</span>
                                </label>
                                <input type="file" (change)="onFileChange($event, i)" class="input" [disabled]="isAdmin"
                                    [class.invalid]="!isAdmin && showError(i)" />
                                <div class="uploaded-file" *ngIf="uploadedFiles[i]">
                                    {{ uploadedFiles[i].name }}
                                </div>
                                <div *ngIf="(responses.at(i).get('value')?.value) as url"
                                    class="text-xs text-gray-500 mt-1">
                                    Fichier enregistré :
                                    <a [href]="url" target="_blank" rel="noopener">{{ url }}</a>
                                </div>
                            </div>
                            <!-- DATE -->
                            <div *ngIf="q.type === 'DATE'" class="input-container">
                                <label class="label">
                                    {{ q.text }}
                                    <span *ngIf="q.required" class="required-asterisk">*</span>
                                </label>
                                <div class="input-wrapper">
                                    <input type="date" class="input" formControlName="value" [disabled]="isAdmin" [class.invalid]="!isAdmin && showError(i)"  (blur)="onFieldBlur(i)" />
                                </div>
                                <div class="error-text" *ngIf="showError(i)">Ce champ est requis</div>
                            </div>


                        </div>
                    </ng-container>
                </div>
            </ng-container>
        </div>

        <div class="input-container mt-5" *ngIf="isAdmin">
      <label class="label">Commentaire de l’administrateur</label>
      <div class="input-wrapper">
        <textarea formControlName="comment" class="input textarea"
          placeholder="Saisissez un commentaire ou une note complémentaire..." rows="5"></textarea>
      </div>

      <!-- Historique -->
      <div class="history" *ngIf="historyLoaded">
        <div class="history-title">Historique de cette étape</div>

        <!-- Debug temporaire -->
        <!-- <pre>{{ history | json }}</pre> -->

        <ng-container *ngIf="history.length > 0; else noHistory">
          <ul class="timeline">
            <li *ngFor="let h of history; trackBy: trackByHistory" class="timeline-item">
              <button class="t-close" type="button" (click)="openDeleteConfirm(h)" aria-label="Supprimer">×</button>

              <div class="t-row">
                <span class="t-badge">{{ prettifyAction(h.action) }}</span>
                <span class="t-time">{{ h.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="t-desc" *ngIf="h.description">{{ h.description }}</div>
              <div class="t-actor">par {{ h.actor?.displayName || h.actor?.email }}</div>
            </li>
          </ul>

        </ng-container>


        <!-- Backdrop -->
        <div class="modal-backdrop" *ngIf="confirmOpen" (click)="cancelDelete()"></div>

        <!-- Modal -->
        <div class="modal" *ngIf="confirmOpen" (keydown.escape)="cancelDelete()" tabindex="0" role="dialog"
          aria-modal="true">
          <div class="modal-panel">
            <div class="modal-head">
              <h3>Supprimer l’entrée</h3>
              <button type="button" class="icon" (click)="cancelDelete()" aria-label="Fermer">×</button>
            </div>

            <div class="modal-body">
              Voulez-vous vraiment supprimer cette entrée d’historique ?
            </div>

            <div class="modal-actions">
              <button type="button" class="btn ghost" (click)="cancelDelete()">Annuler</button>
              <button type="button" class="btn danger" (click)="doDelete()">Supprimer</button>
            </div>
          </div>
        </div>



        <ng-template #noHistory>
          <div class="empty">Aucun historique pour cette étape.</div>
        </ng-template>
      </div>

    </div>


        <!-- ✅ Bouton Valider -->
        <div class="form-actions">
            <button type="submit" class="btn-primary">Valider </button>
        </div>

    </form>

    <!-- ✅ Spinner de chargement -->
    <div class="loading-spinner" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Chargement en cours...</p>
    </div>
</div>