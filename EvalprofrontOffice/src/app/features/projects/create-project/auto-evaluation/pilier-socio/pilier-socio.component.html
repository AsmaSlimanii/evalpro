<div class="form-container">
    <form [formGroup]="formGroup" (ngSubmit)="submit()" *ngIf="!isLoading">
        <!-- ✅ En-tête -->
        <div class="form-header text-center">
            <h2 class="form-title">{{ formMetadata?.title }}</h2>
        </div>

        <h2 class="pillar-title">Pilier Socio-Territorial</h2>

        <div class="form-subtitle-box">
            Durabilité socio-territoriale : indiquez comment votre projet renforce les liens sociaux, l’implication
            locale et le territoire.
        </div>

        <!-- ✅ Bannières conditionnelles -->
        <div class="form-banner clickable" *ngIf="currentSection === 1">Socio 1 : Recrutement permanent</div>
        <div class="form-banner clickable" *ngIf="currentSection === 2">Socio 2 : Emploi décent</div>
        <div class="form-banner clickable" *ngIf="currentSection === 3">Socio 3 : Ancrage territorial</div>
        <div class="form-banner clickable" *ngIf="currentSection === 4">Socio : Compléments</div>


        <!-- ✅ Questions dynamiques -->
        <div formArrayName="responses">
            <ng-container *ngFor="let q of allQuestions; let i = index">
                <div *ngIf="isQuestionInCurrentSection(q)" [formGroupName]="i" class="form-section">

                    <h3 *ngIf="q.type === 'SECTION_TITLE'" class="text-primary mb-3">{{ q.text }}</h3>

                    <!-- TEXTE / NUMERIQUE -->
                    <div *ngIf="q.type === 'TEXTE' || q.type === 'NUMERIQUE'" class="input-container">
                        <label class="label">{{ q.text }}<span *ngIf="q.is_required"
                                class="required-asterisk">*</span></label>
                        <div class="input-wrapper">
                            <input [type]="q.type === 'NUMERIQUE' ? 'number' : 'text'" class="input"
                                formControlName="value" [placeholder]="q.placeholder || 'Votre réponse'"
                                   [readonly]="isAdmin" [disabled]="isAdmin"  [class.invalid]="!isAdmin && showError(i)" (blur)="onFieldBlur(i)" />
                        </div>
                        <div class="error-text" *ngIf="showError(i)">Ce champ est requis</div>
                    </div>

                    <!-- CHOIXMULTIPLE -->
                    <!-- ✅ CORRIGÉ -->
                    <div *ngIf="q.type === 'CHOIXMULTIPLE' && q.options?.length" class="option-group">
                        <label class="label">{{ q.text }}<span *ngIf="q.is_required"
                                class="required-asterisk">*</span></label>

                        <div *ngFor="let opt of q.options" class="checkbox-container">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" [value]="opt.id"
                                    [checked]="isOptionChecked(i, opt.id)"
                                    (change)="onCheckboxToggle(i, opt.id, $event)" [disabled]="isAdmin"  [class.invalid]="!isAdmin && showError(i)" />
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-text">{{ opt.value }}</span>
                            </label>
                        </div>
                    </div>


                    <!-- CHOIX UNIQUE (RADIO) -->
                    <!-- ✅ CHOIX UNIQUE (RADIO) -->
                    <div *ngIf="q.type === 'RADIO' && q.options?.length" class="option-group">
                        <label class="label">{{ q.text }}<span *ngIf="q.is_required"
                                class="required-asterisk">*</span></label>
                        <div *ngFor="let opt of q.options" class="radio-container">
                            <label class="radio-label">
                                <input type="radio" class="radio-input" [value]="opt.id"
                                    [checked]="isRadioSelected(i, opt.id)" (change)="onRadioChange(i, opt.id)"
                                    name="radio-{{i}}" [disabled]="isAdmin"  [class.invalid]="!isAdmin && showError(i)" />
                                <span class="radio-custom"></span>
                                <span class="radio-text">{{ opt.value }}</span>
                            </label>
                        </div>
                    </div>



                </div>
            </ng-container>
        </div>
        <div class="input-container mt-5" *ngIf="isAdmin">
      <label class="label">Commentaire de l’administrateur</label>
      <div class="input-wrapper">
        <textarea formControlName="comment" class="input textarea"
          placeholder="Saisissez un commentaire ou une note complémentaire..." rows="5"></textarea>
      </div>

      <!-- Historique -->
      <div class="history" *ngIf="historyLoaded">
        <div class="history-title">Historique de cette étape</div>

        <!-- Debug temporaire -->
        <!-- <pre>{{ history | json }}</pre> -->

        <ng-container *ngIf="history.length > 0; else noHistory">
          <ul class="timeline">
            <li *ngFor="let h of history; trackBy: trackByHistory" class="timeline-item">
              <button class="t-close" type="button" (click)="openDeleteConfirm(h)" aria-label="Supprimer">×</button>

              <div class="t-row">
                <span class="t-badge">{{ prettifyAction(h.action) }}</span>
                <span class="t-time">{{ h.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="t-desc" *ngIf="h.description">{{ h.description }}</div>
              <div class="t-actor">par {{ h.actor?.displayName || h.actor?.email }}</div>
            </li>
          </ul>

        </ng-container>


        <!-- Backdrop -->
        <div class="modal-backdrop" *ngIf="confirmOpen" (click)="cancelDelete()"></div>

        <!-- Modal -->
        <div class="modal" *ngIf="confirmOpen" (keydown.escape)="cancelDelete()" tabindex="0" role="dialog"
          aria-modal="true">
          <div class="modal-panel">
            <div class="modal-head">
              <h3>Supprimer l’entrée</h3>
              <button type="button" class="icon" (click)="cancelDelete()" aria-label="Fermer">×</button>
            </div>

            <div class="modal-body">
              Voulez-vous vraiment supprimer cette entrée d’historique ?
            </div>

            <div class="modal-actions">
              <button type="button" class="btn ghost" (click)="cancelDelete()">Annuler</button>
              <button type="button" class="btn danger" (click)="doDelete()">Supprimer</button>
            </div>
          </div>
        </div>



        <ng-template #noHistory>
          <div class="empty">Aucun historique pour cette étape.</div>
        </ng-template>
      </div>

    </div>



        <!-- ✅ Boutons de navigation -->
        <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="onPrevious()">← Précédent</button>
            <ng-container [ngSwitch]="currentSection">
                <button *ngSwitchCase="1" type="button" class="btn-primary" (click)="goToSection(2)">→ Socio 2</button>
                <button *ngSwitchCase="2" type="button" class="btn-primary" (click)="goToSection(3)">→ Socio 3</button>
                <button *ngSwitchCase="3" type="button" class="btn-primary" (click)="goToSection(4)">→
                    Compléments</button>
                <button *ngSwitchCase="4" type="submit" class="btn-primary">Valider</button>
            </ng-container>
        </div>
    </form>

    <!-- ✅ Loading -->
    <div class="loading-spinner" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Chargement en cours...</p>
    </div>
</div>