<div class="ai-wrap">
  <header class="ai-head">
    <h1>AI Form Designer</h1>
    <p>Décris l’étape et laisse l’IA générer un formulaire. Tu peux ensuite l’enregistrer.</p>
  </header>

  <section class="ai-grid">
    <!-- Brief / commandes -->
    <div class="panel brief">
      <form (ngSubmit)="generate()" #f="ngForm">
        <div class="row">
          <label>Step ID</label>
          <input type="number" name="stepId" [(ngModel)]="stepId" min="1">
        </div>

        <div class="row">
          <label>Nom d'étape</label>
          <input type="text" name="stepName" [(ngModel)]="stepName" />
        </div>

        <div class="row">
          <label>Consignes (ce que tu veux dans le formulaire)</label>
          <textarea name="description" rows="4"
                    [(ngModel)]="description"
                    placeholder="Ex: Nom du projet, budget (nombre), catégorie (liste), description courte..."></textarea>
        </div>

        <div class="actions">
          <button type="submit" [disabled]="loading">
            <i class="fas fa-wand-magic-sparkles"></i>
            {{ loading ? 'Génération...' : 'Générer' }}
          </button>

          <button type="button" class="ghost" (click)="save()" [disabled]="!schema || saving">
            <i class="fas fa-save"></i>
            {{ saving ? 'Enregistrement...' : 'Enregistrer' }}
          </button>

          <label class="toggle">
            <input type="checkbox" [(ngModel)]="chatMode" name="chatMode"> Mode chat (beta)
          </label>
        </div>

        <p class="err" *ngIf="error">{{ error }}</p>
      </form>

      <!-- Chat (optionnel) -->
      <div class="chat" *ngIf="chatMode">
        <div class="messages">
          <div class="msg" *ngFor="let m of messages" [class.me]="m.role==='user'">
            <div class="bubble">
              <strong *ngIf="m.role==='user'">Toi :</strong>
              <strong *ngIf="m.role==='assistant'">IA :</strong>
              <span>{{ m.text }}</span>
            </div>
          </div>
        </div>
        <form class="chat-input" (ngSubmit)="send()">
          <input [(ngModel)]="chatText" name="chatText" placeholder="Décris le formulaire à générer..." />
          <button [disabled]="!chatText || loading"><i class="fas fa-paper-plane"></i></button>
        </form>
      </div>
    </div>

    <!-- Aperçu -->
    <div class="panel preview" *ngIf="schema; else empty">
      <h3 class="title">{{ schema.title }}</h3>

      <form class="preview-form">
        <div class="f" *ngFor="let f of schema.fields">
          <label>{{ f.label }} <span *ngIf="f.required" class="req">*</span></label>

          <input *ngIf="f.type==='text' || f.type==='number' || f.type==='date'"
                 [attr.type]="f.type==='text' ? 'text' : f.type"
                 [placeholder]="f.placeholder || ''">

          <textarea *ngIf="f.type==='textarea'" [placeholder]="f.placeholder || ''"></textarea>

          <select *ngIf="f.type==='select'">
            <option *ngFor="let o of f.options" [value]="o">{{ o }}</option>
          </select>

          <label class="check" *ngIf="f.type==='checkbox'">
            <input type="checkbox"> {{ f.placeholder || 'Oui / Non' }}
          </label>
        </div>
      </form>
    </div>

    <ng-template #empty>
      <div class="panel empty">
        <p>Lance une génération pour voir un aperçu.</p>
      </div>
    </ng-template>
  </section>
</div>
