<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FormServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">EvalPro</a> &gt; <a href="index.source.html" class="el_package">com.medianet.evalpro.Service</a> &gt; <span class="el_source">FormServiceImpl.java</span></div><h1>FormServiceImpl.java</h1><pre class="source lang-java linenums">package com.medianet.evalpro.Service;

import com.medianet.evalpro.Dto.FormDTO;
import com.medianet.evalpro.Dto.FormProgressDTO;
import com.medianet.evalpro.Dto.OptionDTO;
import com.medianet.evalpro.Dto.QuestionDTO;
import com.medianet.evalpro.Entity.*;
import com.medianet.evalpro.Mapper.QuestionMapper;
import com.medianet.evalpro.Mapper.ResponseMapper;
import com.medianet.evalpro.Repository.*;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.*;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class FormServiceImpl implements FormService {

    private final FormRepository formRepository;
    private final QuestionRepository questionRepository;
    private final ResponseRepository responseRepository;
    private final StepRepository stepRepository;
    private final ResponseMapper responseMapper;
    private final QuestionMapper questionMapper;
    private final ResponseAdminRepository responseAdminRepository;



    @Override
    public Form save(Form form) {
<span class="nc" id="L37">        return formRepository.save(form);</span>
    }

    @Override
    public List&lt;Form&gt; findAll() {
<span class="nc" id="L42">        return formRepository.findAll();</span>
    }

    @Override
    public Optional&lt;Form&gt; findById(Long id) {
<span class="nc" id="L47">        return formRepository.findById(id);</span>
    }

    @Override
    public Form update(Long id, Form form) {
<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (!formRepository.existsById(id)) {</span>
<span class="nc" id="L53">            throw new RuntimeException(&quot;Formulaire non trouv√©&quot;);</span>
        }
<span class="nc" id="L55">        form.setId(id);</span>
<span class="nc" id="L56">        return formRepository.save(form);</span>
    }

    @Override
    public void deleteById(Long id) {
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (!formRepository.existsById(id)) {</span>
<span class="nc" id="L62">            throw new RuntimeException(&quot;Formulaire non trouv√©&quot;);</span>
        }
<span class="nc" id="L64">        formRepository.deleteById(id);</span>
<span class="nc" id="L65">    }</span>

    @Override
    public Page&lt;Form&gt; searchForms(String q, int page, int perPage) {
<span class="nc" id="L69">        Pageable pageable = PageRequest.of(page, perPage, Sort.by(&quot;id&quot;).ascending());</span>
<span class="nc" id="L70">        return formRepository.findByTitleContainingIgnoreCase(q, pageable);</span>
    }

    @Override
    public FormDTO getFormByStep(String stepName) {
<span class="nc" id="L75">        Step step = stepRepository.findByName(stepName)</span>
<span class="nc" id="L76">                .orElseThrow(() -&gt; new RuntimeException(&quot;√âtape introuvable : &quot; + stepName));</span>

<span class="nc" id="L78">        Form form = step.getForms().stream().findFirst()</span>
<span class="nc" id="L79">                .orElseThrow(() -&gt; new RuntimeException(&quot;Aucun formulaire trouv√© pour cette √©tape&quot;));</span>

<span class="nc" id="L81">        List&lt;QuestionDTO&gt; questionDTOs = form.getQuestions().stream()</span>
<span class="nc" id="L82">                .map(questionMapper::toDTO)</span>
<span class="nc" id="L83">                .collect(Collectors.toList());</span>


<span class="nc" id="L86">        return FormDTO.builder()</span>
<span class="nc" id="L87">                .id(form.getId())</span>
<span class="nc" id="L88">                .title(form.getTitle())</span>
<span class="nc" id="L89">                .description(form.getDescription())</span>
<span class="nc" id="L90">                .questions(questionDTOs)</span>
<span class="nc" id="L91">                .build();</span>
    }


    @Override
    public FormDTO getFormWithResponses(String step, Long dossierId) {
<span class="nc" id="L97">        Form form = (Form) formRepository.findByStepName(step)</span>
<span class="nc" id="L98">                .orElseThrow(() -&gt; new RuntimeException(&quot;Form not found&quot;));</span>

<span class="nc" id="L100">        Long stepId = form.getStep().getId(); // üî¥ tu r√©cup√®res l'ID de l'√©tape</span>

<span class="nc" id="L102">        List&lt;Question&gt; questions = questionRepository.findAllByStepId(stepId);</span>

<span class="nc" id="L104">        List&lt;Response&gt; responses = responseRepository.findByFormIdAndDossierId(form.getId(), dossierId);</span>

<span class="nc" id="L106">        List&lt;QuestionDTO&gt; questionDTOs = questions.stream().map(q -&gt; {</span>
<span class="nc" id="L107">            QuestionDTO qDto = questionMapper.toDTO(q); // ‚úÖ utilise le mapper avec parentQuestionId etc.</span>

            // injecter la r√©ponse texte/num√©rique
<span class="nc" id="L110">            qDto.setValue(</span>
<span class="nc" id="L111">                    responses.stream()</span>
<span class="nc bnc" id="L112" title="All 4 branches missed.">                            .filter(r -&gt; r.getQuestion().getId().equals(q.getId()) &amp;&amp; r.getValue() != null)</span>
<span class="nc" id="L113">                            .map(Response::getValue)</span>
<span class="nc" id="L114">                            .findFirst()</span>
<span class="nc" id="L115">                            .orElse(null)</span>
            );

            // injecter les options s√©lectionn√©es
<span class="nc" id="L119">            qDto.setOptionIds(</span>
<span class="nc" id="L120">                    responses.stream()</span>
<span class="nc bnc" id="L121" title="All 4 branches missed.">                            .filter(r -&gt; r.getQuestion().getId().equals(q.getId()) &amp;&amp; r.getOption() != null)</span>
<span class="nc" id="L122">                            .map(r -&gt; r.getOption().getId())</span>
<span class="nc" id="L123">                            .collect(Collectors.toList())</span>
            );

            // injecter les options avec selected = true
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (q.getOptions() != null) {</span>
<span class="nc" id="L128">                List&lt;OptionDTO&gt; optionDTOs = q.getOptions().stream().map(o -&gt; {</span>
<span class="nc" id="L129">                    boolean isSelected = responses.stream().anyMatch(r -&gt;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                            r.getQuestion().getId().equals(q.getId()) &amp;&amp;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                                    r.getOption() != null &amp;&amp;</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                                    r.getOption().getId().equals(o.getId())</span>
                    );
<span class="nc" id="L134">                    return OptionDTO.builder()</span>
<span class="nc" id="L135">                            .id(o.getId())</span>
<span class="nc" id="L136">                            .value(o.getValue())</span>
<span class="nc" id="L137">                            .selected(isSelected)</span>
<span class="nc" id="L138">                            .build();</span>
<span class="nc" id="L139">                }).collect(Collectors.toList());</span>

<span class="nc" id="L141">                qDto.setOptions(optionDTOs);</span>
            }

<span class="nc" id="L144">            return qDto;</span>
<span class="nc" id="L145">        }).collect(Collectors.toList());</span>



<span class="nc" id="L149">       List&lt;ResponseAdmin&gt; adminComment = responseAdminRepository.findByDossierIdAndStepId(dossierId, form.getStep().getId());</span>



<span class="nc" id="L153">        return FormDTO.builder()</span>
<span class="nc" id="L154">                .id(form.getId())</span>
<span class="nc" id="L155">                .title(form.getTitle())</span>
<span class="nc" id="L156">                .description(form.getDescription())</span>
<span class="nc" id="L157">                .questions(questionDTOs)</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                .comment(adminComment.isEmpty() ? null : adminComment.get(0).getComment())</span>
<span class="nc" id="L159">                .responses(responses.stream()</span>
<span class="nc" id="L160">                        .map(responseMapper::toDto)</span>
<span class="nc" id="L161">                        .collect(Collectors.toList()))</span>
<span class="nc" id="L162">                .build();</span>
    }

    public Map&lt;String, Integer&gt; getPillarProgressPercentage(Long dossierId) {
<span class="nc" id="L166">        Map&lt;String, Integer&gt; progressMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L167">        List&lt;String&gt; pillars = List.of(&quot;ECONOMIQUE&quot;, &quot;SOCIO&quot;, &quot;ENVIRONNEMENTAL&quot;);</span>
<span class="nc" id="L168">        Long stepId = 3L; // ID de l'√©tape auto-√©valuation</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">        for (String pillar : pillars) {</span>
<span class="nc" id="L171">            long totalQuestions = Optional.ofNullable(</span>
<span class="nc" id="L172">                    questionRepository.countQuestionsByPillarAndStep(pillar, stepId)</span>
<span class="nc" id="L173">            ).orElse(0L);</span>

<span class="nc" id="L175">            Long answered = Optional.ofNullable(</span>
<span class="nc" id="L176">                    responseRepository.countResponsesByDossierIdAndPillar(dossierId, pillar)</span>
<span class="nc" id="L177">            ).orElse(0L);</span>

<span class="nc bnc" id="L179" title="All 2 branches missed.">            int progress = (totalQuestions == 0) ? 0 : (int) Math.round(answered * 100.0 / totalQuestions);</span>

<span class="nc" id="L181">            progressMap.put(pillar, progress);</span>
<span class="nc" id="L182">            System.out.println(&quot;Progress &quot; + pillar + &quot;: &quot; + answered + &quot;/&quot; + totalQuestions + &quot; ‚Üí &quot; + progress + &quot;%&quot;);</span>
<span class="nc" id="L183">        }</span>

<span class="nc" id="L185">        return progressMap;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>